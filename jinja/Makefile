# This is a magic Makefile which will use jinjatool.py to build a static
# website. It knows how to ask jinjatool.py to calculate dependencies and
# update itself with whatever rules are necessary.
#
JINJATOOL ?= `find . -name jinjatool.py`
MP_RFC822 ?= `find . -name template.md-jinja`

MAKE = make JINJATOOL=$(JINJATOOL) MP_RFC822=$(MP_RFC822) --no-print-directory
TARGETS = find . -name \*.jinja* -o -name \*.md \
            |grep -v -e '.swp$$' -e '.py$$' -e '~$$' |sort \
            |sed -e 's/md$$/html/g' \
                 -e 's/jinja-rss$$/rss/g' \
                 -e 's/jinja$$/html/g'


all:
	@$(TARGETS) |xargs -r $(MAKE)

clean: cleanMakefile
	@$(TARGETS) |xargs -r rm -f

loop: depend
	@while [ 1 ]; do \
	  $(TARGETS) |xargs -r $(MAKE) \
            |grep -v 'up to date' \
            || sleep 1; \
         done

%.rss: %.jinja-rss
	LC_ALL=C $(JINJATOOL) $<:$@

%.html: %.jinja
	LC_ALL=C $(JINJATOOL) $<:$@

%.html: %.md
	LC_ALL=C $(JINJATOOL) dir="`pwd`" MP_RFC822_FILE="$<" $(MP_RFC822):$@

%.jinja: %.jinja.py
	(cd $(<D); ./$(<F)) > $@

%.jinja:
	@touch $@

%.jinja-rss:
	@touch $@

%.md: %.md.py
	(cd $(<D); ./$(<F)) > $@

%.md:
	@touch $@

%.md-jinja:
	@touch $@

%.html-jinja:
	@touch $@

cleanMakefile:
	@sed '/ $$DEPS$$ /,$$ d' <Makefile >/tmp/Makefile.clean
	@cp -f /tmp/Makefile.clean Makefile
	@rm -f /tmp/Makefile.clean

depend: cleanMakefile
	@echo '## $$DEPS$$ ## AUTOGENERATED LINES FOLLOW ##' >>Makefile
	(export M=$(MP_RFC822); $(JINJATOOL) --deps \
            `find . -name \*.jinja* |grep -v .swp |sort` \
            `find . -name \*.md -printf "MP_RFC822_FILE=%p $$M:%p\\n" |sort` \
        ) >>Makefile


## $DEPS$ ## AUTOGENERATED LINES FOLLOW ##
blog/index.jinja: blog blog/2013-08-08_Mailpile_Launched.md blog/2013-08-11_Designing_Security.md blog/2013-08-11_IndieGoGo_Update_1.md blog/2013-08-15_Digging_Through_the_Details.md blog/2013-08-20_Turning_Money_Into_Code.md blog/2013-08-21_IndieGoGo_Update_2.md blog/2013-08-30_Fonts_and_Copyright_Licenses.md blog/2013-09-05_IndieGoGo_Update_3.md blog/2013-09-05_PayPal_Freezes_Campaign_Funds.md blog/2013-09-06_IndieGoGo_Update_4.md blog/2013-09-10_IndieGoGo_Update_5.md blog/2013-09-10_Surveillance_Centralization.md blog/2013-09-11_Budget_and_Roadmap.md blog/2013-09-12_IndieGoGo_Update_6.md blog/2013-10-11_The_Month_of_Dog_Fooding.md blog/2013-10-31_DarkMail_and_Secure_Protocols.md blog/2013-11-01_IndieGoGo_Update_7.md blog/2013-11-18_Speaking_your_language.md blog/2013-11-23_A_Pound_of_Security.md blog/2014-01-12_A_Plan_For_Spam.md blog/2014-01-31_Alpha_Release_Shipping_Bits_and_Atoms.md blog/2014-02-07_IndieGoGo_Update_8.md blog/2014-04-07_Workshop_in_London.md blog/2014-04-30_Where_is_the_Community_Site.md blog/2014-06-03_Mailpile_Alpha_II.md blog/2014-08-08_Our_Upcoming_Beta_Release.md blog/2014-08-20_Upcoming_Beta_Release_Part_II.md blog/2014-09-13_Mailpile_Beta_Release.md blog/2014-10-07_Some_Thoughts_on_GnuPG.md jinja/layouts/page.html-jinja
blog/index.jinja-rss: blog blog/2014-06-03_Mailpile_Alpha_II.md blog/2014-08-08_Our_Upcoming_Beta_Release.md blog/2014-08-20_Upcoming_Beta_Release_Part_II.md blog/2014-09-13_Mailpile_Beta_Release.md blog/2014-10-07_Some_Thoughts_on_GnuPG.md
demos/index.jinja: jinja/layouts/page.html-jinja
demos/sorry.jinja: demos/index.jinja jinja/layouts/page.html-jinja
donate/cancel.jinja: donate/index.jinja jinja/layouts/page.html-jinja
donate/index.jinja: jinja/layouts/page.html-jinja
donate/thanks.jinja: donate/index.jinja jinja/layouts/page.html-jinja
download/index.jinja: jinja/layouts/page.html-jinja
jinja/tests/jinja-test.jinja: jinja/tests jinja/tests/md-test.md
press/index.jinja: jinja/layouts/page.html-jinja press press/2013-08-09_50000_USD_a_einni_viku.md press/2013-08-09_50000_USD_in_one_week.md
providers/index.jinja: jinja/layouts/page.html-jinja
roadmap/index.jinja: jinja/layouts/page.html-jinja roadmap/roadmap.html
blog/2013-08-08_Mailpile_Launched.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-08-11_Designing_Security.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-08-11_IndieGoGo_Update_1.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-08-15_Digging_Through_the_Details.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-08-20_Turning_Money_Into_Code.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-08-21_IndieGoGo_Update_2.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-08-30_Fonts_and_Copyright_Licenses.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-09-05_IndieGoGo_Update_3.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-09-05_PayPal_Freezes_Campaign_Funds.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-09-06_IndieGoGo_Update_4.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-09-10_IndieGoGo_Update_5.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-09-10_Surveillance_Centralization.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-09-11_Budget_and_Roadmap.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-09-12_IndieGoGo_Update_6.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-10-11_The_Month_of_Dog_Fooding.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-10-31_DarkMail_and_Secure_Protocols.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-11-01_IndieGoGo_Update_7.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-11-18_Speaking_your_language.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2013-11-23_A_Pound_of_Security.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-01-12_A_Plan_For_Spam.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-01-31_Alpha_Release_Shipping_Bits_and_Atoms.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-02-07_IndieGoGo_Update_8.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-04-07_Workshop_in_London.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-04-30_Where_is_the_Community_Site.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-06-03_Mailpile_Alpha_II.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-08-08_Our_Upcoming_Beta_Release.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-08-20_Upcoming_Beta_Release_Part_II.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-09-13_Mailpile_Beta_Release.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
blog/2014-10-07_Some_Thoughts_on_GnuPG.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
faq/faq.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
faq/features.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
faq/index.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
index.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
jinja/tests/md-test.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
press/2013-08-09_50000_USD_a_einni_viku.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
press/2013-08-09_50000_USD_in_one_week.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
thank-you/index.md: jinja/layouts/page.html-jinja jinja/template.md-jinja
