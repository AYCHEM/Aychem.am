# This is a magic Makefile which will use jinjatool.py to build a static
# website. It knows how to ask jinjatool.py to calculate dependencies and
# update itself with whatever rules are necessary.
#
all:
	@find . -name \*.jinja |sed -e s/jinja/html/g \
          |xargs make --no-print-directory

clean: cleanMakefile
	@find . -name \*.jinja |sed -e s/jinja/html/g \
          |xargs rm -f

loop: depend
	@while [ 1 ]; do \
	  find . -name \*.jinja |sed -e s/jinja/html/g \
            |xargs make --no-print-directory \
            |grep -v 'up to date' \
            && make depend --no-print-directory \
            || sleep 1; \
         done

%.html: %.jinja
	jinjatool.py $<:$@

%.jinja:
	@touch $@

cleanMakefile:
	@sed '/ $$DEPS$$ /,$$ d' <Makefile >Makefile.clean
	@mv -f Makefile.clean Makefile

depend: cleanMakefile
	@echo '## $$DEPS$$ ## AUTOGENERATED LINES FOLLOW ##' >>Makefile
	jinjatool.py --deps `find . -name \*.jinja` >>Makefile

