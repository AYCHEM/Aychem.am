# This is a magic Makefile which will use jinjatool.py to build a static
# website. It knows how to ask jinjatool.py to calculate dependencies and
# update itself with whatever rules are necessary.
#
JINJATOOL ?= `find . -name jinjatool.py`
MP_RFC822 ?= `find . -name md-template.jt`

MAKE = make JINJATOOL=$(JINJATOOL) MP_RFC822=$(MP_RFC822) --no-print-directory
TARGETS = find . -name \*.jinja -o -name \*.md \
            |sed -e 's/md$$/html/g' -e 's/jinja$$/html/g'


all:
	@$(TARGETS) |xargs -r $(MAKE)

clean: cleanMakefile
	@$(TARGETS) |xargs -r rm -f

loop: depend
	@while [ 1 ]; do \
	  $(TARGETS) |xargs -r $(MAKE) \
            |grep -v 'up to date' \
            && $(MAKE) depend \
            || sleep 1; \
         done

%.html: %.jinja
	$(JINJATOOL) $<:$@

%.html: %.md
	$(JINJATOOL) dir="`pwd`" MP_RFC822_FILE="$<" $(MP_RFC822):$@

%.jinja:
	@touch $@

%.md:
	@touch $@

cleanMakefile:
	@sed '/ $$DEPS$$ /,$$ d' <Makefile >/tmp/Makefile.clean
	@cp -f /tmp/Makefile.clean Makefile
	@rm -f /tmp/Makefile.clean

depend: cleanMakefile
	@echo '## $$DEPS$$ ## AUTOGENERATED LINES FOLLOW ##' >>Makefile
	$(JINJATOOL) --deps `find . -name \*.jinja` >>Makefile
	@find . -name \*.md -exec $(JINJATOOL) \
          --deps dir="`pwd`" MP_RFC822_FILE="{}" "$(MP_RFC822):{}" \; \
          >>Makefile

